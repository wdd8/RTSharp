syntax = "proto3";

option csharp_namespace = "RTSharp.Daemon.Protocols";

import "google/protobuf/wrappers.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

service GRPCFilesService {
    rpc GetDirectoryInfo (google.protobuf.StringValue) returns (FileSystemItem);
    rpc CreateDirectory (google.protobuf.StringValue) returns (google.protobuf.Empty);
    rpc RemoveEmptyDirectory (google.protobuf.StringValue) returns (google.protobuf.Empty);
    rpc MediaInfo (MediaInfoInput) returns (MediaInfoReply);
    rpc CheckExists (CheckExistsInput) returns (CheckExistsReply);
    rpc AllowedToDelete (AllowedToDeleteInput) returns (AllowedToDeleteReply);
    rpc AllowedToRead (AllowedToReadInput) returns (AllowedToReadReply);
    rpc HashFileBlock (HashFileBlockInput) returns (google.protobuf.BytesValue);
    rpc LinkFiles (LinkFilesInput) returns (google.protobuf.Empty);

    rpc Internal_SendFiles (SendFilesInput) returns (stream FileBuffer);
    rpc SaveFiles (SaveFilesFromRemoteInput) returns (stream SaveFilesFromRemoteReply);
}

message LinkFilesInput {
    enum LinkType {
        option allow_alias = true;
        LinkType_NA = 0x00;
        LinkType_HARDLINK = 0x01;
        LinkType_REFLINK = 0x02;
        LinkType_MAX = 0x02;
    }

    repeated string Source = 1;
    repeated string Target = 2;
    LinkType Type = 3;
}

message HashFileBlockInput {
    enum HashAlgorithm {
        HashAlgorithm_SHA1 = 0;
        HashAlgorithm_SHA256 = 1;
    }

    string Path = 1;
    uint64 Start = 2;
    uint64 End = 3;
    HashAlgorithm Algorithm = 4;
}

message AllowedToReadInput {
    repeated string Paths = 1;
}

message AllowedToReadReply {
    message PathWithStatus {
        string Path = 1;
        bool Value = 2;
    }
    
    repeated PathWithStatus Reply = 1;
}

message AllowedToDeleteInput {
    repeated string Paths = 1;
}

message AllowedToDeleteReply {
    message PathWithStatus {
        string Path = 1;
        bool Value = 2;
    }
    
    repeated PathWithStatus Reply = 1;
}

message SaveFilesFromRemoteReply {
    google.protobuf.StringValue File = 1;
    uint64 BytesReceived = 2;
}

message SaveFilesFromRemoteInput {
    repeated string Paths = 1;
}

message SendFilesInput {
    repeated string Paths = 1;
}

message FileBuffer {
    oneof Data {
        string Path = 1;
        bytes Buffer = 2;
    }
}

message CheckExistsInput {
    repeated string Paths = 1;
}

message CheckExistsReply {
    map<string, bool> Existence = 1;
}

message MediaInfoInput {
    repeated string Paths = 1;
}

message MediaInfoReply {
    repeated string Output = 1;
}

message FileSystemItem {
    repeated FileSystemItem Children = 1;
    bool Directory = 2;
    string Path = 3;
    uint64 Size = 4;
    google.protobuf.Timestamp LastModified = 5;
    string Permissions = 6;
}